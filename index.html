<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <!-- è¡Œå‹•è£ç½®ï¼šé—œé–‰ç¸®æ”¾ã€é›™æ“Šæ”¾å¤§ã€pinch -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DFJK ç¯€å¥éŠæˆ²</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    html, body { touch-action: manipulation; }
    body {
      margin: 0; background: #0f1220; color: #fff; font-family: sans-serif;
      text-align: center; transition: background 0.5s ease;
    }
    body.ex-mode { background: linear-gradient(to bottom, #ff3300, #990000, #000000); }
    canvas {
      display: block; margin: 20px auto; background: #1f2340; border: 2px solid #fff;
      width: 95%; max-width: 420px; height: auto; touch-action: manipulation;
    }
    .hitbar {
      display: flex; justify-content: space-between; align-items: flex-end;
      width: 95%; max-width: 420px; margin: -90px auto 40px; height: 90px; position: relative; z-index: 2;
    }
    .hitkey {
      flex: 1; margin: 0 5px; height: 90px; border: 3px solid transparent; border-radius: 50%;
      background: rgba(255,255,255,.05); font-size: 36px; font-weight: bold;
      display: flex; align-items: center; justify-content: center;
      transition: transform .2s, box-shadow .2s; user-select: none; -webkit-user-select: none; touch-action: manipulation;
    }
    #key-d { color:#b266ff; border-color:#b266ff; }  #key-f { color:#66ccff; border-color:#66ccff; }
    #key-j { color:#66ff66; border-color:#66ff66; }  #key-k { color:#ff6666; border-color:#ff6666; }
    .hitkey.flash { transform: scale(1.4); box-shadow: 0 0 20px currentColor; background: rgba(255,255,255,.2); }

    .hud { font-size: 18px; margin-top: 10px; line-height: 1.6; }
    .songline { font-size: 14px; opacity: .9; }
    button {
      margin:10px; padding:10px 20px; font-size:18px; background:#78d5ff; border:none; border-radius:8px; cursor:pointer;
    }
    #menuScreen, #endScreen, #optionsScreen, #pauseScreen { padding-top: 120px; }
    .blur { filter: blur(6px); pointer-events: none; user-select: none; }
    #pauseButton { position: absolute; top: 10px; right: 10px; z-index: 3; }
    .countdown {
      position: absolute; top: 40%; left: 50%; transform: translate(-50%,-50%);
      font-family: 'Fredoka One', sans-serif; font-size: 72px; color: #fff; text-shadow: 2px 2px 8px #000; z-index: 5;
      animation: pop .6s ease-out; pointer-events: none;
    }
    @keyframes pop {
      0% { transform: scale(.5) translate(-50%,-50%); opacity:0; }
      50% { transform: scale(1.2) translate(-50%,-50%); opacity:1; }
      100% { transform: scale(1) translate(-50%,-50%); opacity:0; }
    }
    .row { margin: 10px 0; }
    label { margin-right: 6px; }
    select { padding: 6px 10px; border-radius: 6px; border: 1px solid #445; background:#12152a; color:#fff; }
  </style>
</head>
<body>
  <!-- ä¸»é¸å–® -->
  <div id="menuScreen">
    <h1>ğŸµ DFJK ç¯€å¥éŠæˆ²</h1>
    <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
    <button onclick="showOptions()">é¸é …</button>
  </div>

  <!-- é¸é … -->
  <div id="optionsScreen" style="display:none;">
    <h2>âš™ï¸ éŠæˆ²é¸é …</h2>

    <div class="row">
      <label for="difficultySelect">é›£åº¦ï¼š</label>
      <select id="difficultySelect">
        <option value="ex">EXï¼ˆæ¥µé™ï¼‰</option>
        <option value="hell">åœ°ç„</option>
        <option value="hard">å›°é›£</option>
        <option value="normal" selected>æ™®é€š</option>
        <option value="easy">ç°¡å–®</option>
        <option value="beginner">åˆå­¸è€…</option>
      </select>
    </div>

    <div class="row">
      <label for="speedMultiplier">é€Ÿåº¦å€ç‡ï¼š</label>
      <select id="speedMultiplier">
        <option value="1">1.0xï¼ˆæ¨™æº–ï¼‰</option>
        <option value="1.1">1.1x</option>
        <option value="1.2">1.2x</option>
        <option value="1.3">1.3x</option>
        <option value="1.6">1.6x</option>
        <option value="2.0">2.0x</option>
      </select>
    </div>

    <div class="row">
      <label for="noteDirection">éŸ³ç¬¦æ–¹å‘ï¼š</label>
      <select id="noteDirection">
        <option value="down" selected>ä¸‹è½æ‰“æ“Šï¼ˆæ‰“æ“Šç·šåœ¨åº•ï¼‰</option>
        <option value="up">ä¸Šå‡æ‰“æ“Šï¼ˆæ‰“æ“Šç·šåœ¨é ‚ï¼‰</option>
      </select>
    </div>

    <div class="row">
      <label for="judgeMode">åˆ¤å®šæ¨¡å¼ï¼š</label>
      <select id="judgeMode">
        <option value="old" selected>Old Inputï¼ˆå« WRONGï¼‰</option>
        <option value="new">New Inputï¼ˆç§»é™¤ WRONGï¼‰</option>
      </select>
    </div>

    <div class="row">
      <button onclick="goToMenu()">å›ä¸»é¸å–®</button>
    </div>
  </div>

  <!-- éŠæˆ²ç•«é¢ -->
  <div id="gameScreen" style="display:none; position:relative;">
    <button id="pauseButton" onclick="pauseGame()">â¸ï¸</button>
    <canvas id="gameCanvas" width="420" height="640"></canvas>

    <div class="hitbar">
      <div class="hitkey" id="key-d">â†</div>
      <div class="hitkey" id="key-f">â†“</div>
      <div class="hitkey" id="key-j">â†‘</div>
      <div class="hitkey" id="key-k">â†’</div>
    </div>

    <div class="hud">
      åˆ†æ•¸ï¼š<span id="score">0</span>ã€€
      é€£æ“Šï¼š<span id="combo">0</span>ã€€
      åˆ¤å®šï¼š<span id="judgement">-</span>ã€€
      MISSï¼š<span id="missCount">0</span>
      <div class="songline">
        æ›²ç›®ï¼š<span id="songTitle">-</span>ã€€ï½œã€€é›£åº¦ï¼š<span id="diffLabel">-</span>ã€€ï½œã€€æ–¹å‘ï¼š<span id="dirLabel">-</span>ã€€ï½œã€€åˆ¤å®šï¼š<span id="judgeLabel">-</span>
      </div>
    </div>
  </div>

  <!-- æš«åœ -->
  <div id="pauseScreen" style="display:none;">
    <h2>â¸ï¸ éŠæˆ²æš«åœ</h2>
    <button onclick="resumeGame()">â–¶ï¸ ç¹¼çºŒ</button>
    <button onclick="goToMenu()">å›ä¸»é¸å–®</button>
  </div>

  <!-- çµç®— -->
  <div id="endScreen" style="display:none;">
    <h2>ğŸ® éŠæˆ²çµæŸï¼</h2>
    <p>æ›²ç›®ï¼š<span id="finalSong">-</span></p>
    <p>é›£åº¦ï¼š<span id="finalDiff">-</span></p>
    <p>æ–¹å‘ï¼š<span id="finalDir">-</span></p>
    <p>åˆ¤å®šï¼š<span id="finalJudge">-</span></p>
    <p>åˆ†æ•¸ï¼š<span id="finalScore">0</span></p>
    <p>PERFECTï¼š<span id="statPerfect">0</span></p>
    <p>GREATï¼š<span id="statGreat">0</span></p>
    <p>GOODï¼š<span id="statGood">0</span></p>
    <p>BADï¼š<span id="statBad">0</span></p>
    <p>WRONGï¼š<span id="statWrong">0</span></p>
    <p>MISSï¼š<span id="statMiss">0</span></p>
    <button onclick="startGame()">å†ç©ä¸€æ¬¡</button>
    <button onclick="goToMenu()">å›ä¸»é¸å–®</button>
  </div>

  <!-- å€’æ•¸æ–‡å­— -->
  <div id="countdownText" class="countdown" style="display:none;"></div>

  <audio id="hitSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_6e3e3b6f3f.mp3?filename=click-124467.mp3"></audio>
  <audio id="bgm"></audio>

  <script>
    /* ========= åƒæ•¸ ========= */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const laneWidth = W / 4;
    const hitkeyHeight = 90;

    // æ‰“æ“Šç·šä½ç½®ä¾æ–¹å‘åˆ‡æ›
    const getJudgeLineY = () => {
      const dir = document.getElementById('noteDirection').value;
      return (dir === 'up') ? (hitkeyHeight / 2) : (H - hitkeyHeight / 2);
    };

    const keys = ['d','f','j','k'];

    let score = 0, combo = 0, lastJudgementText = '-';
    let startTime = 0, running = false, paused = false, loopId = null;
    let chart = [], comboFlash = '';
    let elapsedTimeBeforePause = 0;

    const hitSound = document.getElementById('hitSound');
    const bgm = document.getElementById('bgm');

    let baseNoteSpeed = 550;
    let noteSpeed = baseNoteSpeed;

    const JUDGE_WINDOW_MS = 200;
    const MISS_Y_OFFSET = 40;
    const TOUCH_WINDOW_MS = 200;

    // çµ±è¨ˆ
    let missCount = 0;
    let gameOver = false;
    let stats = { perfect:0, great:0, good:0, bad:0, wrong:0, miss:0 };

    // ç•¶å‰è³‡è¨Š
    let currentSongTitle = '-';
    let currentDifficulty = '-';
    let currentDirection = 'down';
    let currentJudgeMode = 'old';

    // æ›²åº«ï¼ˆè«‹ç¢ºä¿ /music å…§æª”åä¸€è‡´ï¼‰
    const SONGS = [
      "Charlie Puth - Light Switch [Official Music Video] - Charlie Puth.mp3",
      "Creepy Nuts - ã‚ªãƒˆãƒã‚±(Otonoke) ã€Official MVã€‘ [Dandadan OP] - Creepy Nuts.mp3",
      "Creepy Nuts â€Mirageâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Opening Theme Song - Creepy Nuts.mp3",
      "Creepy Nuts â€Nemureâ€ Ã— Anime â€Call of the Nightâ€ Collaboration Music Video Ending Theme Song - Creepy Nuts (1).mp3",
      "Creepy Nutsï½¢Bling-Bang-Bang-Bornï½£ Ã— TV Animeï½¢ãƒãƒƒã‚·ãƒ¥ãƒ«-MASHLE-ï½£ Collaboration Music Video #BBBBãƒ€ãƒ³ã‚¹ - Creepy Nuts.mp3",
      "KANA-BOON - Silhouette - KANABOONVEVO.mp3",
      "Lost Sky - Fearless pt.II (feat. Chris Linton) Trap NCS - Copyright Free Music - NoCopyrightSounds.mp3",
      "Lost Sky - Vision pt. II (feat. She Is Jules) Future Trap NCS - Copyright Free Music - NoCopyrightSounds.mp3",
      "Lost Sky - Where We Started (feat. Jex) Melodic Dubstep NCS - Copyright Free Music - NoCopyrightSounds.mp3",
      "Lost Sky, Sara Skinner - Dreams pt. II (feat. Sara Skinner) [NCS Release].mp3",
      "OneRepublic - Nobody (from Kaiju No. 8) [Official Music Video] - OneRepublicVEVO.mp3",
      "YOASOBIã€ŒWatch me!ã€Official Music Video - Ayase _ YOASOBI.mp3",
      "yung kai - blue (official music video) - yung kai.mp3",
      "ã€AKASAKIã€‘Bunny Girl _ ãƒãƒ‹ãƒ¼ã‚¬ãƒ¼ãƒ«ï¼ˆLyric Videoï¼‰ - AKASAKI (19).mp3",
      "ã€MVã€‘éš™_ã‚†ãƒ¼ã‚Šã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã€‘ - ã‚†ãƒ¼ã‚ŠğŸğŸ¥ã€”24ã€•ãƒ»yuri (1).mp3",
      "ã€imaseã€‘NIGHT DANCERï¼ˆMVï¼‰ - imase.mp3",
      "ã€ã‚ªãƒªã‚¸ãƒŠãƒ«æ¥½æ›²ã€‘ç²›è–!! ãƒ­ãƒªç¥ãƒ¬ã‚¯ã‚¤ã‚¨ãƒ â˜† _ ã—ãã‚Œã†ã„ï¼ˆ9ã•ã„ï¼‰ã€IOSYSï¼ˆã¾ã‚ã‚“&D.wattï¼‰ã€‘ - ã—ãã‚Œã†ã„.mp3",
      "ãªã¨ã‚Š - Overdose - ãªã¨ã‚Š _ natori.mp3",
      "ãƒ­ã‚¯ãƒ‡ãƒŠã‚·ã€ŒãŸã å£°ä¸€ã¤ã€_ Rokudenashi - One Voiceã€Official Music Videoã€‘ - ãƒ­ã‚¯ãƒ‡ãƒŠã‚· _ Rokudenashi.mp3",
      "å¥½ãã ã‹ã‚‰ã€‚_ ã€ãƒ¦ã‚¤ã‚«ã€ã€MVã€‘ - ã€ãƒ¦ã‚¤ã‚«ã€.mp3",
      "å»»å»»å¥‡è­š - Eve MV - Eve.mp3",
      "é’ã®ã™ã¿ã‹ _ ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ - Where Our Blue Is _ Tatsuya Kitani - ã‚­ã‚¿ãƒ‹ã‚¿ãƒ„ãƒ¤ _ Tatsuya Kitani.mp3"
    ];

    /* ====== HUD ====== */
    function updateHUD() {
      document.getElementById('score').textContent = score;
      document.getElementById('combo').textContent = combo;
      document.getElementById('judgement').textContent = lastJudgementText;
      document.getElementById('missCount').textContent = missCount;
      document.getElementById('songTitle').textContent = currentSongTitle;
      document.getElementById('diffLabel').textContent = currentDifficulty.toUpperCase();
      document.getElementById('dirLabel').textContent = (currentDirection === 'up' ? 'ä¸Šå‡' : 'ä¸‹è½');
      document.getElementById('judgeLabel').textContent = (currentJudgeMode === 'old' ? 'Old' : 'New');
    }

    /* ====== è¦–è¦ºï¼šæŒ‰éµäº®èµ· ====== */
    function flashKeyByLane(laneIdx) {
      const id = ['d','f','j','k'][laneIdx];
      const el = document.getElementById('key-' + id);
      if (!el) return;
      el.classList.add('flash');
      setTimeout(() => el.classList.remove('flash'), 120);
    }

    /* ====== åˆ¤å®š ====== */
    function judge(dtMs) {
      const adt = Math.abs(dtMs);
      let j = 'GOOD', add = 300;

      if (adt <= 50)      { j = 'PERFECT'; add = 1000; stats.perfect++; }
      else if (adt <= 100){ j = 'GREAT';   add =  600; stats.great++;   }
      else if (adt <= 150){ j = 'GOOD';    add =  300; stats.good++;    }
      else                { j = 'BAD';     add =  100; stats.bad++;     }

      score += add;
      combo += 1;
      lastJudgementText = j;
      updateHUD();
      hitSound.currentTime = 0;
      hitSound.play();

      if (combo % 10 === 0) {
        comboFlash = `COMBO x${combo}!!`;
        setTimeout(() => comboFlash = '', 800);
      }
    }

    function miss() {
      lastJudgementText = 'MISS';
      combo = 0;
      missCount++;
      stats.miss++;
      updateHUD();

      // EXï¼š15 æ¬¡ MISS ç›´æ¥å¤±æ•—
      if (currentDifficulty === 'ex' && missCount > 15) {
        triggerFailOnce('ä½ è¼¸äº†ï¼EX æ¨¡å¼ MISS è¶…é 15 æ¬¡');
      }
    }

    function triggerFailOnce(msg) {
      if (gameOver) return;
      gameOver = true;
      running = false;
      try { cancelAnimationFrame(loopId); } catch {}
      try { bgm.pause(); } catch {}
      setTimeout(() => { alert(msg); goToMenu(); }, 0);
    }

    /* ====== ç”¢è­œ ====== */
    function generateChart(durationSec) {
      chart = [];
      const difficulty = currentDifficulty;

      // éš¨æ©Ÿåƒæ•¸
      let time = 1;
      let doubleNoteChance = 0.35;
      let timeGapMin = 0.20;
      let timeGapMax = 0.45;

      if (difficulty === 'beginner') {
        doubleNoteChance = 0.15; timeGapMin = 0.30; timeGapMax = 0.60;
      } else if (difficulty === 'easy') {
        doubleNoteChance = 0.20; timeGapMin = 0.25; timeGapMax = 0.50;
      } else if (difficulty === 'normal') {
        doubleNoteChance = 0.35; timeGapMin = 0.20; timeGapMax = 0.45;
      } else if (difficulty === 'hard') {
        doubleNoteChance = 0.55; timeGapMin = 0.15; timeGapMax = 0.35;
      } else if (difficulty === 'hell') {
        doubleNoteChance = 0.75; timeGapMin = 0.10; timeGapMax = 0.25; // â‰¥75%é›™éµ
      } else if (difficulty === 'ex') {
        doubleNoteChance = 0.60; timeGapMin = 0.12; timeGapMax = 0.30;
      }

      if (!(difficulty === 'ex' || difficulty === 'hell')) {
        while (time < durationSec) {
          const lanesUsed = new Set();
          const notesThisFrame = [];
          const count = Math.random() < doubleNoteChance ? 2 : 1;
          while (notesThisFrame.length < count) {
            const lane = Math.floor(Math.random() * 4);
            if (!lanesUsed.has(lane)) {
              lanesUsed.add(lane);
              notesThisFrame.push({ t: time, lane, type: 'tap', hit: false, y: -50 });
            }
          }
          chart.push(...notesThisFrame);
          time += Math.random() * (timeGapMax - timeGapMin) + timeGapMin;
        }
        return;
      }

      // EX / HELLï¼šæ›´å¯†é›†
      const beat = 0.5; // 2 beats/sec
      let t = 1;
      let laneCursor = 0;
      const nextLane = () => { laneCursor = (laneCursor + 1) % 4; return laneCursor; };
      const pushNote = (tt, lane) => chart.push({ t: tt, lane, type: 'tap', hit: false, y: -50 });
      const randLane = () => Math.floor(Math.random() * 4);

      while (t < durationSec) {
        if (difficulty === 'ex') {
          pushNote(t, nextLane());
          if (Math.random() < 0.60) pushNote(t, (laneCursor + 2) % 4);
          if (Math.random() < 0.35) pushNote(t + beat / 2, (laneCursor + 1) % 4);
          if (Math.random() < 0.18) {
            pushNote(t + beat / 3, randLane());
            pushNote(t + 2 * beat / 3, randLane());
          }
          t += Math.random() < 0.5 ? beat / 2 : beat;
        } else {
          pushNote(t, nextLane());
          if (Math.random() < 0.85) pushNote(t, (laneCursor + 2) % 4); // â‰¥75%é›™éµ
          pushNote(t + beat / 2, (laneCursor + 1) % 4);
          if (Math.random() < 0.4) {
            pushNote(t + beat / 4, randLane());
            pushNote(t + 3 * beat / 4, randLane());
          }
          t += beat / 2;
        }
      }
    }

    /* ====== ä½ç½®è¨ˆç®—ï¼ˆæ”¯æ´ä¸Šä¸‹å…©ç¨®æ–¹å‘ï¼‰ ====== */
    function noteYAtTime(n, t) {
      const dir = currentDirection;
      const judgeLineY = getJudgeLineY();
      if (dir === 'down') {
        // å¾€ä¸‹æ‰ï¼št<n.t æ™‚åœ¨ä¸Šæ–¹ï¼›åˆ° n.t é€¼è¿‘æ‰“æ“Šç·š
        return judgeLineY - (n.t - t) * noteSpeed;
      } else {
        // å¾€ä¸Šå‡ï¼št<n.t æ™‚åœ¨ä¸‹æ–¹ï¼›åˆ° n.t é€¼è¿‘æ‰“æ“Šç·šï¼ˆç·šåœ¨é ‚ï¼‰
        return judgeLineY + (n.t - t) * noteSpeed;
      }
    }

    function isMiss(n) {
      const dir = currentDirection;
      const judgeLineY = getJudgeLineY();
      if (dir === 'down') {
        return n.y > judgeLineY + MISS_Y_OFFSET; // æ‰éç·š
      } else {
        return n.y < judgeLineY - MISS_Y_OFFSET; // å‡éç·š
      }
    }

    /* ====== æ›´æ–° & ç¹ªåœ– ====== */
    function update(t) {
      chart.forEach(n => { n.y = noteYAtTime(n, t); });

      chart.forEach(n => {
        if (n.hit) return;
        if (isMiss(n)) {
          n.hit = true;
          miss();
        }
      });
    }

    function render() {
      const judgeLineY = getJudgeLineY();

      ctx.clearRect(0, 0, W, H);
      ctx.strokeStyle = '#fff';
      ctx.beginPath();
      ctx.moveTo(0, judgeLineY);
      ctx.lineTo(W, judgeLineY);
      ctx.stroke();

      const laneColors = ['#b266ff', '#66ccff', '#66ff66', '#ff6666'];
      chart.forEach(n => {
        if (n.hit) return;
        const x = n.lane * laneWidth + laneWidth / 2;
        ctx.fillStyle = laneColors[n.lane];
        ctx.beginPath();
        ctx.arc(x, n.y, 30, 0, Math.PI * 2);
        ctx.fill();
      });

      if (lastJudgementText !== '-') {
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 32px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(lastJudgementText, W / 2, (currentDirection === 'up') ? judgeLineY + 40 : judgeLineY - 40);
      }

      if (comboFlash) {
        ctx.fillStyle = '#ff78b5';
        ctx.font = 'bold 36px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(comboFlash, W / 2, H / 2 - 100);
      }

      if (!running && chart.every(n => n.hit)) {
        document.getElementById('finalSong').textContent = currentSongTitle;
        document.getElementById('finalDiff').textContent = currentDifficulty.toUpperCase();
        document.getElementById('finalDir').textContent  = (currentDirection === 'up' ? 'ä¸Šå‡' : 'ä¸‹è½');
        document.getElementById('finalJudge').textContent= (currentJudgeMode === 'old' ? 'Old' : 'New');
        document.getElementById('finalScore').textContent = score;
        document.getElementById('statPerfect').textContent = stats.perfect;
        document.getElementById('statGreat').textContent = stats.great;
        document.getElementById('statGood').textContent = stats.good;
        document.getElementById('statBad').textContent = stats.bad;
        document.getElementById('statWrong').textContent = stats.wrong;
        document.getElementById('statMiss').textContent = stats.miss;

        document.getElementById('gameScreen').style.display = 'none';
        document.getElementById('endScreen').style.display = 'block';
      }
    }

    function loop(ts) {
      if (paused) return;
      const t = (ts - startTime) / 1000;
      update(t);
      render();

      if (chart.every(n => n.hit)) {
        running = false;
        lastJudgementText = 'END';
        updateHUD();

        document.getElementById('finalSong').textContent = currentSongTitle;
        document.getElementById('finalDiff').textContent = currentDifficulty.toUpperCase();
        document.getElementById('finalDir').textContent  = (currentDirection === 'up' ? 'ä¸Šå‡' : 'ä¸‹è½');
        document.getElementById('finalJudge').textContent= (currentJudgeMode === 'old' ? 'Old' : 'New');
        document.getElementById('finalScore').textContent = score;
        document.getElementById('statPerfect').textContent = stats.perfect;
        document.getElementById('statGreat').textContent = stats.great;
        document.getElementById('statGood').textContent = stats.good;
        document.getElementById('statBad').textContent = stats.bad;
        document.getElementById('statWrong').textContent = stats.wrong;
        document.getElementById('statMiss').textContent = stats.miss;

        document.getElementById('gameScreen').style.display = 'none';
        document.getElementById('endScreen').style.display = 'block';
        return;
      }

      loopId = requestAnimationFrame(loop);
    }

    /* ====== è¼¸å…¥ ====== */
    window.addEventListener('keydown', e => {
      const k = e.key.toLowerCase();
      const idx = keys.indexOf(k);
      if (idx !== -1) { pressLane(idx); }
      if (e.key === 'Escape') { paused ? resumeGame() : pauseGame(); }
    });

    ['d','f','j','k'].forEach((k, idx) => {
      const el = document.getElementById('key-' + k);
      el.addEventListener('pointerdown', (e) => { e.preventDefault(); pressLane(idx); }, { passive: false });
    });

    canvas.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const lane = Math.min(3, Math.max(0, Math.floor(x / laneWidth)));
      pressLane(lane);
    }, { passive: false });

    function pressLane(lane) {
      if (!running) return;

      const tNow = (performance.now() - startTime) / 1000;
      let targetIndex = -1, bestAbs = Infinity;

      for (let i = 0; i < chart.length; i++) {
        const n = chart[i];
        if (n.hit || n.lane !== lane) continue;
        const dtMs = (tNow - n.t) * 1000;
        const adt = Math.abs(dtMs);
        if (adt <= TOUCH_WINDOW_MS && adt < bestAbs) {
          bestAbs = adt; targetIndex = i;
        }
      }

      if (targetIndex >= 0) {
        const n = chart[targetIndex];
        judge((tNow - n.t) * 1000);
        n.hit = true;
        flashKeyByLane(lane);
      } else {
        // æ²’æœ‰åœ¨åˆ¤å®šçª—å…§çš„éŸ³ç¬¦
        if (currentJudgeMode === 'old') {
          lastJudgementText = 'WRONG';
          score = Math.max(0, score - 100);
          combo = 0;
          stats.wrong++;
          updateHUD();
        }
        flashKeyByLane(lane);
      }
    }

    /* ====== å€’æ•¸ ====== */
    function showCountdown(callback) {
      const countdownText = document.getElementById('countdownText');
      const steps = ['Ready', '3', '2', '1', 'Go!'];
      let i = 0;
      function nextStep() {
        if (i >= steps.length) { countdownText.style.display = 'none'; callback(); return; }
        countdownText.textContent = steps[i];
        countdownText.style.display = 'block';
        countdownText.classList.remove('countdown'); void countdownText.offsetWidth;
        countdownText.classList.add('countdown');
        i++; setTimeout(nextStep, 700);
      }
      nextStep();
    }

    /* ====== æµç¨‹ ====== */
    function startGame() {
      // è¨­å®šèˆ‡ HUD
      const difficulty = document.getElementById('difficultySelect').value;
      const speedMultiplierSelect = document.getElementById('speedMultiplier');
      const dir = document.getElementById('noteDirection').value;
      const jmode = document.getElementById('judgeMode').value;
      currentDifficulty = difficulty;
      currentDirection  = dir;
      currentJudgeMode  = jmode;

      let multiplier = parseFloat(speedMultiplierSelect.value);
      if      (difficulty === 'beginner') multiplier = 0.8;
      else if (difficulty === 'easy')     multiplier = 0.9;
      else if (difficulty === 'ex')       multiplier = 1.8;
      noteSpeed = baseNoteSpeed * multiplier;

      document.body.classList.toggle('ex-mode', difficulty === 'ex');

      // é‡ç½®ç‹€æ…‹
      try { bgm.pause(); } catch {}
      cancelAnimationFrame(loopId);
      score = 0; combo = 0; lastJudgementText = '-'; comboFlash = '';
      chart = []; paused = false; running = true; missCount = 0; gameOver = false;
      stats = { perfect:0, great:0, good:0, bad:0, wrong:0, miss:0 };
      elapsedTimeBeforePause = 0;
      updateHUD();

      // éš¨æ©Ÿé¸æ­Œ
      const pick = SONGS[Math.floor(Math.random() * SONGS.length)];
      currentSongTitle = pick.replace(/\.mp3$/i, '');
      const url = 'music/' + encodeURIComponent(pick);
      bgm.src = url;
      bgm.load();

      // ç•«é¢åˆ‡æ›
      document.getElementById('menuScreen').style.display = 'none';
      document.getElementById('optionsScreen').style.display = 'none';
      document.getElementById('endScreen').style.display = 'none';
      document.getElementById('pauseScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'block';
      document.getElementById('gameScreen').classList.remove('blur');
      updateHUD();

      // å…ˆç”¨å®‰å…¨é è¨­ 120 ç§’ç”Ÿæˆï¼Œmetadata åˆ°æ™‚å†ã€Œè¦†è“‹é‡ç”¢ã€
      let chartFinalized = false;
      generateChart(120);

      bgm.onloadedmetadata = () => {
        if (chartFinalized) return;
        const durationSec = (!isNaN(bgm.duration) && bgm.duration > 0) ? bgm.duration : 120;
        generateChart(durationSec);
        chartFinalized = true;
      };

      // å€’æ•¸å¾Œç«‹å³é–‹å§‹ï¼ˆé™ä½ç­‰å¾…ï¼‰
      showCountdown(() => {
        startTime = performance.now();
        bgm.currentTime = 0;
        bgm.play().catch(()=>{});
        loopId = requestAnimationFrame(loop);
      });
    }

    function pauseGame() {
      if (!running || paused) return;
      paused = true;
      try { bgm.pause(); } catch {}
      cancelAnimationFrame(loopId);
      elapsedTimeBeforePause = (performance.now() - startTime) / 1000;
      document.getElementById('gameScreen').classList.add('blur');
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('pauseScreen').style.display = 'block';
    }

    function resumeGame() {
      if (!paused) return;
      paused = false;
      document.getElementById('pauseScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'block';
      document.getElementById('gameScreen').classList.remove('blur');

      showCountdown(() => {
        startTime = performance.now() - (elapsedTimeBeforePause * 1000);
        bgm.play().catch(()=>{});
        loopId = requestAnimationFrame(loop);
      });
    }

    function goToMenu() {
      document.getElementById('endScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('optionsScreen').style.display = 'none';
      document.getElementById('pauseScreen').style.display = 'none';
      document.getElementById('menuScreen').style.display = 'block';
      document.getElementById('gameScreen').classList.remove('blur');
      document.body.classList.remove('ex-mode');
      try { bgm.pause(); } catch {}
    }

    function showOptions() {
      document.getElementById('menuScreen').style.display = 'none';
      document.getElementById('optionsScreen').style.display = 'block';
    }

    // ç¦å³éµ / ç¦ç¸®æ”¾
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('dblclick', e => e.preventDefault());
  </script>
</body>
</html>









































